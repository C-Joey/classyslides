\NeedsTeXFormat{LaTeX2e}
\ProvidesClass{beamerthemeclassyslidesbase}[2017/24/12 template definitions for classy slides]

\RequirePackage[utf8]{inputenc}
\RequirePackage[T1]{fontenc}
\RequirePackage{color}
\RequirePackage{listings, lstautogobble}
\RequirePackage{tikz}
\RequirePackage{pdftexcmds}
\RequirePackage{graphicx}
\RequirePackage[most]{tcolorbox}
\RequirePackage[breakwords]{truncate}
\RequirePackage{biblatex}
\RequirePackage{lastpage}
\RequirePackage{refcount}

% COLOR DEFINITIONS
\colorlet{accent-color}{blue}
\colorlet{highlight-color}{blue!75}

% HYPERREF SETTINGS
\hypersetup{colorlinks=false}

% TIKZ SETTINGS
\usetikzlibrary{positioning, shapes.arrows, shapes.misc, fadings, calc, shadows.blur, patterns}
\tikzfading[name=fade right, left color=transparent!0, right color=transparent!100]
\tikzfading[name=fade left, left color=transparent!100, right color=transparent!0]

% Declare pgf layers for z-level in tikz pictures
% HREF http://tex.stackexchange.com/a/20426
\pgfdeclarelayer{back}
\pgfdeclarelayer{front}
\pgfsetlayers{back,main,front}

% Define tikz keys for layering.
% HREF http://tex.stackexchange.com/a/20426
\pgfkeys{%
    /tikz/on layer/.code={
        \pgfonlayer{#1}\begingroup
            \aftergroup\endpgfonlayer
            \aftergroup
        \endgroup
    },
    /tikz/node on layer/.code={
        \gdef\node@@on@layer{%
            \setbox\tikz@tempbox=\hbox\bgroup\pgfonlayer{#1}\unhbox\tikz@tempbox\endpgfonlayer\egroup%
        }%
        \aftergroup\node@on@layer%
    },
    /tikz/end node on layer/.code={%
        \endpgfonlayer\endgroup\endgroup%
    }%
}
\def\node@on@layer{\aftergroup\node@@on@layer}

% TCOLORBOX SETTINGS
\tcbuselibrary{skins}
\tcbuselibrary{listings}

% BEAMER SETTINGS
\usetheme{default}
\useoutertheme{infolines}
\useinnertheme{circles}
\setbeamersize{text margin left=0.5cm,text margin right=0.5cm}

\setbeamercolor{normal text}{bg=background-color, fg=foreground-color}
\setbeamercolor{title page}{parent=normal text}
\setbeamercolor{title}{parent=title page}
\setbeamercolor{subtitle}{parent=title page}
\setbeamercolor{frametitle}{parent=normal text}
\setbeamercolor{alerted text}{fg=highlight-color}
\setbeamercolor{progress bar}{fg=accent-color}
\setbeamercolor{block}{parent=normal text}
\setbeamercolor{block title}{parent=normal text}
\setbeamercolor{itemize item}{parent=normal text, fg=highlight-color}
\setbeamercolor{itemize subitem}{parent=itemize item}
\setbeamercolor{enumerate item}{parent=itemize item}
\setbeamercolor{enumerate subitem}{parent=itemize item}
\setbeamercolor{section in toc}{parent=normal text}
\setbeamercolor{subsection in toc}{parent=normal text}
\setbeamercolor{caption name}{fg=accent-color}
\setbeamercolor*{bibliography item}{parent=normal text}
\setbeamercolor*{bibliography entry author}{parent=normal text, fg=highlight-color}
\setbeamercolor*{bibliography entry title}{parent=normal text}
\setbeamercolor*{bibliography entry journal}{parent=normal text}
\setbeamercolor*{bibliography entry location}{parent=normal text}
\setbeamercolor*{bibliography entry note}{parent=normal text}

\setbeamerfont{normal text}{family=\sffamily, size=\Large}
\setbeamerfont{title page}{family=\rmfamily}
\setbeamerfont{title}{parent=title page, size=\Huge}
\setbeamerfont{subtitle}{parent=title page, size=\Large}
\setbeamerfont{author}{family=\sffamily, size=\small, series=\fontseries{l}\selectfont}
\setbeamerfont{institute}{family=\sffamily, size=\small, series=\fontseries{l}\selectfont}
\setbeamerfont{date}{family=\sffamily, size=\small, series=\fontseries{l}\selectfont}
\setbeamerfont{section in section page}{family=\rmfamily, size=\Huge}
\setbeamerfont{subsection in section page}{family=\rmfamily, size=\Large}
\setbeamerfont{frametitle}{family=\sffamily, size=\LARGE, series=\bfseries\itshape\selectfont}
\setbeamerfont{footline}{family=\rmfamily}
\setbeamerfont{section in toc}{family=\sffamily, series=\bfseries}
\setbeamerfont{subsection in toc}{family=\sffamily, series=\fontseries{l}\selectfont}
\setbeamerfont{caption}{series=\itshape\bfseries, family=\flafamily, size=\scriptsize}
\setbeamerfont{caption name}{parent=caption, series=\upshape\bfseries}
\setbeamerfont{block}{parent=normal text, series=\upshape\selectfont}
\setbeamerfont{block title}{parent=frametitle, size=\large}


% VARIABLES
\newif\ifcontentpage\contentpagefalse

\newcounter{@@frame}
\newcounter{@@total}

\colorlet{background-color}{white}
\colorlet{foreground-color}{black}
\colorlet{accent-color}{blue}
\colorlet{highlight-color}{accent-color!50}

% TEMPLATES
\defbeamertemplate{headline}{classy headline}[1][]{%
    \bgroup%
    \@ifundefined{r@LastPage}{}{%
        \setcounter{@@frame}{\thepage}%
        \setcounter{@@total}{\getpagerefnumber{LastPage}}%
        \addtocounter{@@frame}{-1}%
        \addtocounter{@@total}{-1}%
        \ifnum\the@@total=0%
            \dimen0=\paperwidth%
        \else%
            \dimen0=\paperwidth%
            \divide\dimen0 by 100%
            \multiply\dimen0 by \the@@frame%
            \divide\dimen0 by \the@@total%
            % This equals `<paperwidth>/100 * (<frames> - 1) / (<total> - 1) * 100`
            \multiply\dimen 0 by 100%
        \fi%
        \edef\progressbarwidth{\the\dimen0}%
        \begin{beamercolorbox}[wd=\paperwidth, ht=0.5cm]{headline}%
            % Don't draw the progress bar on the first page
            \ifnum\thepage=1\relax%
            \else%
                \usebeamercolor{progress bar}%
                \begin{tikzpicture}%
                    \draw[draw=none, use as bounding box] (0, 0) rectangle (\paperwidth, 0.5cm);%
                    \draw[on layer=back, draw=none, fill=fg!15] (0, 0) rectangle (\paperwidth, 0.5cm);%
                    \draw[on layer=main, draw=none, fill=fg] (0, 0) rectangle (\progressbarwidth, 0.5cm);%
                    \draw[on layer=main, draw=fg!50!bg, line width=1pt] (0, 0cm) -- (\paperwidth, 0cm);%
                \end{tikzpicture}%
            \fi
        \end{beamercolorbox}
    }%
	\egroup%
}
\setbeamertemplate{headline}[classy headline]

\defbeamertemplate{frametitle}{classy frametitle}[1][0]{%
    \bgroup%
    \begin{beamercolorbox}[wd=\paperwidth, ht=1.5cm]{frametitle}%
        \begin{tikzpicture}%
            \draw[draw=none, use as bounding box] (0, 0) rectangle (\paperwidth, 1.5cm);%
            \node[outer sep=0pt, inner sep=12pt, minimum height=1.50cm, below right=0pt and 0pt of current bounding box.north west] {%
                \truncate{\linewidth}{%
                    \insertframetitle%
                    % In case of a split frame, append the frame partition number.
                    \ifnum\insertcontinuationcount=0\else~(\insertcontinuationcount)\fi%
                }%
            };%
        \end{tikzpicture}%
    \end{beamercolorbox}%
    \egroup%
}
\setbeamertemplate{frametitle}[classy frametitle]

% Remove navigation symbols
\setbeamertemplate{navigation symbols}{}
\defbeamertemplate{footline}{my footline}[1][0]{%
    \bgroup%
        % Only draw the footline on content pages
        \begin{beamercolorbox}[sep=\dimexpr0.33\dimexpr0.5cm, ht=.5cm, wd=\paperwidth, right]{footline}%
            \ifnum\thepage=1\else%
                \ifcontentpage%
                    \edef\frame{\the\numexpr\the@@frame + 1}%
                    \edef\total{\the\numexpr\the@@total + 1}%
                    \frame~of \total
                \else%
                \fi%
            \fi%
        \end{beamercolorbox}%
	\egroup%
}
\setbeamertemplate{footline}[my footline]

\defbeamertemplate{title page}{classy title page}[1][0]{%
    \bgroup%
    \noindent%
    \vskip2em%
    \begin{beamercolorbox}[sep=0.10cm, center]{title}%
        \usebeamercolor{title}\usebeamerfont{title}%
        \inserttitle\par%
    \end{beamercolorbox}\par%
    \vskip0.5cm\par%
    \begin{beamercolorbox}[sep=0.10cm, center]{subtitle}%
        \usebeamercolor{subtitle}\usebeamerfont{subtitle}
        \ifx\insertsubtitle\@empty\relax\else\insertsubtitle\fi%
    \end{beamercolorbox}\par%
    \vskip0.25cm\relax%
    \begin{beamercolorbox}[sep=0.20cm, center]{}%
        \ifx\insertinstitute\@empty\relax\else{\usebeamerfont{institute}\usebeamercolor{institute}\insertinstitute}\\\fi%
        {\usebeamerfont{author}\usebeamercolor{author}\insertauthor}\\%
        \ifx\insertdate\@empty\relax\else{\usebeamerfont{date}\usebeamercolor{date}\insertdate}\\\fi%
        \ifx\inserttitlegraphic\@empty\relax\else{\usebeamercolor[fg]{titlegraphic}\inserttitlegraphic}\fi%
    \end{beamercolorbox}\par%
    \egroup%
}
\setbeamertemplate{title page}[classy title page]

\defbeamertemplate*{section page}{classy section page}[1][]{%
    \bgroup%
    \noindent%
		% Use a combination of `\makebox` and `\minipage` for centered content
		\makebox[\textwidth][c]{%
            \begin{minipage}[c]{0.85\paperwidth}%
                \vskip2em%
                \begin{beamercolorbox}[sep=0.10cm, center]{section in section page}%
                    \usebeamerfont{section in section page}\usebeamercolor{section in section page}\insertsectionnumber.~\insertsection\par%
                \end{beamercolorbox}\par%
                % Optional subsection
                \ifx\insertsubsection\@empty\relax%
                \else%
                    \vskip0.25cm\par%
                    \begin{beamercolorbox}[sep=0.20cm, center]{subsection in section page}%
                        \usebeamerfont{subsection in section page}\usebeamercolor{subsection in section page}\insertsectionnumber.\insertsubsectionnumber~~\insertsubsection\par%
                    \end{beamercolorbox}\par%
                \fi%
            \end{minipage}
        }%
    \egroup%
}
\setbeamertemplate{classy section page}[my section page]

\defbeamertemplate{itemize item}{classy itemize item}[1][]{%
    \bgroup%
    \usebeamercolor{itemize item}%
    \tikz{%
        \draw[draw=none, use as bounding box] rectangle (\baselineskip, \baselineskip);%
        \node[below left=0pt and 0pt of current bounding box.east, minimum width=0.4\baselineskip, minimum height=0.4\baselineskip, inner sep=0pt, outer sep=0pt, fill=fg, circle] (text) {}%
    }%
    \egroup%
}
\setbeamertemplate{itemize item}[classy itemize item]

\setbeamertemplate{itemize subitem}{%
    \bgroup%
    \usebeamercolor{itemize subitem}\usebeamercolor{itemize subitem}{\color{fg}---}%
    \egroup%
}

\defbeamertemplate{enumerate item}{classy enumerate item}[1][]{%
    \bgroup%
    \usebeamercolor{enumerate item}%
	\tikz[baseline=(text.base)]{%
		\node[minimum width=1.5em, minimum height=1.5em, inner sep=2pt, outer sep=0pt, draw=none] (text) {\color{fg}\insertenumlabel.}%
    }%
    \egroup%
}
\setbeamertemplate{enumerate item}[classy enumerate item]

\defbeamertemplate{enumerate subitem}{classy enumerate subitem}[1][]{%
    \bgroup%
    \usebeamercolor{enumerate subitem}%
	\color{fg}\insertsubenumlabel%
	\egroup%
}
\setbeamertemplate{enumerate subitem}[classy enumerate subitem]

\setbeamertemplate{itemize/enumerate body begin}{\Large}
\setbeamertemplate{itemize/enumerate subbody begin}{\Large}
%
% PATCHES
%

% NOTE patch footline
\defbeamertemplate{footline}{my classy footline}[1][0]{%
}
\setbeamertemplate{footline}[my classy footline]

% NOTE patch headline
\defbeamertemplate{headline}{my classy headline}[1][0]{%
}
\setbeamertemplate{headline}[my classy headline]

% NOTE patch itemize item template, color
\defbeamertemplate{itemize item}{my classy itemize item}[1][]{%
    \bgroup%
    \usebeamercolor{itemize item}%
    \tikz{%
        \node[anchor=base, minimum width=0.3\baselineskip, minimum height=0.3\baselineskip, inner sep=0pt, outer sep=0pt, fill=fg, circle] (text) {}%
    }%
    \egroup%
}
\setbeamertemplate{itemize item}[my classy itemize item]
\setbeamercolor{itemize item}{fg=accent-color, bg=}

\defbeamertemplate{itemize subitem}{my classy itemize subitem}[1][]{%
    \bgroup%
    \usebeamercolor{itemize subitem}\usebeamerfont{itemize subitem}\color{fg}--%
    \egroup%
}
\setbeamertemplate{itemize subitem}[my classy itemize subitem]

% NOTE patch frametitle
\defbeamertemplate{frametitle}{my classy frametitle}[1][0]{%
\bgroup%
\begin{beamercolorbox}[wd=\paperwidth, ht=1.5cm]{frametitle}%
  \begin{tikzpicture}%
    \draw[draw=none, use as bounding box] (0, 0) rectangle (\paperwidth, 1.5cm);%
    \node[outer sep=0pt, inner sep=12pt, minimum height=1.50cm, below right=0pt and 0pt of current bounding box.north west] {%
    \truncate{\linewidth}{%
    \insertframetitle%
    % In case of a split frame, append the frame partition number.
    % \ifnum\insertcontinuationcount=0\else~(\insertcontinuationcount)\fi%
    }%
    };%
  \end{tikzpicture}%
\end{beamercolorbox}%
\egroup%
}
\setbeamertemplate{frametitle}[my classy frametitle]

% NOTE patch table of contents left margin
\setbeamertemplate{section in toc}{%
  \bgroup%
  \usebeamerfont{section in toc}\usebeamercolor{section in toc}%
  \hskip12pt\relax%
  \inserttocsectionnumber.~\inserttocsection\par%
  \egroup%
}
\setbeamertemplate{subsection in toc}{%
  \bgroup%
  \usebeamerfont{subsection in toc}\usebeamercolor{subsection in toc}%
  \hskip24pt\relax%
  \inserttocsectionnumber.\inserttocsubsectionnumber.~\inserttocsubsection\par%
  \egroup%
}
%
% /PATCHES
%

% HREF http://tex.stackexchange.com/a/69721
\setbeamertemplate{section in toc}{{\usebeamerfont{section in toc}\usebeamercolor{section in toc}\inserttocsectionnumber.~\inserttocsection}\par}
\setbeamertemplate{subsection in toc}{\hskip1em\relax\usebeamerfont{subsection in toc}\usebeamercolor{subsection in toc}\inserttocsectionnumber.\inserttocsubsectionnumber.~\inserttocsubsection\par}

% HREF https://tex.stackexchange.com/a/176862
\setbeamertemplate{bibliography item}[text]

\newenvironment<>{Block}[2][]{%
    \bgroup%
    \usebeamerfont{block}\usebeamercolor{block}\color{fg}%
	\tcbset{%
		enhanced%
		, sharp corners%
        , no shadow%
		, top=0pt%
		, right=0pt%
		, bottom=0pt%
		, left=0pt%
		, toptitle=0pt%
		, bottomtitle=-12pt%
		, middle=0pt%
		, boxsep=12pt%
		, boxrule=0pt%
		, colframe=bg%
		, colback=bg%
		, colbacktitle=bg%
        , title={\usebeamerfont{block title}\usebeamercolor{block title}\color{fg}{#2}}%
		, #1
	}%
	\begin{tcolorbox}%
	\usebeamercolor{block}\usebeamerfont{block}\color{fg}%
}{%
	\end{tcolorbox}%
	\egroup%
}

\renewenvironment<>{Theorem}[2][]{%
	\begin{Block}[#1]{Theorem: #2}%
}{%
	\end{Block}
}
\renewenvironment<>{Proof}[1][]{%
	\begin{Block}[#1]{Proof:}%
}{%
	\end{Block}
}

\renewenvironment<>{Example}[1][]{%
	\begin{Block}[#1]{Example:}%
}{%
	\end{Block}
}

\renewenvironment<>{Definition}[2][]{%
	\begin{Block}[#1]{Definition: #2}%
}{%
	\end{Block}
}

\newtcblisting{Code}[2][]{%
    code={
        \usebeamercolor{block}\usebeamerfont{block}%
        \tcbset{%
            , enhanced%
            , sharp corners%
            , no shadow%
            , top=0pt%
            , right=0pt%
            , bottom=0pt%
            , left=0pt%
            , toptitle=0pt%
            , bottomtitle=-12pt%
            , middle=0pt%
            , boxsep=12pt%
            , boxrule=0pt%
            , colframe=bg%
            , colback=bg%
            , colbacktitle=bg%
            , title={%
                \usebeamerfont{block title}\usebeamercolor{block title}\color{fg}{#2}
            }%
        }%
    }%
	, listing only%
	, listing options={%
		breaklines=true%
		, autogobble%
		, tabsize=2%
		, aboveskip=0pt%
		, belowskip=0pt%
		, xleftmargin=0pt%
		, xrightmargin=0pt%
		, framesep=0pt%
		, framerule=0pt%
		, rulesep=0pt%
		, framexrightmargin=0pt%
		, framexleftmargin=0pt%		
        , numbersep=0pt%,
        , basicstyle=\ttfamily\small\color{fg}%
		, language=#1%
    }%
}
