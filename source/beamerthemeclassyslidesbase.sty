\NeedsTeXFormat{LaTeX2e}
\ProvidesClass{beamerthemeclassyslidesbase}[2017/24/12 template definitions for classy slides]

% TODO simplify comments

%!%!%!%!%!%!%!%!%
%! dependencies %
%!%!%!%!%!%!%!%!%

%! font encoding
\RequirePackage[utf8]{inputenc}
\RequirePackage[T1]{fontenc}
%! font style
\RequirePackage{color}
%! verbatim code
\RequirePackage{listings, lstautogobble}
\RequirePackage{tikz}
\RequirePackage{pdftexcmds}
\RequirePackage{graphicx}
\RequirePackage[most]{tcolorbox}
\RequirePackage{bera, cmbright, lato, inconsolata}
% TODO rm?
% \RequirePackage[breakwords]{truncate}

%! Content page flag.
\newif\ifcontentpage\contentpagefalse

% counters
\newcounter{@@frames}
\newcounter{@@total}

\definecolor{background-color}{RGB}{255, 255, 255}
\colorlet{accent-color}{blue}
%\definecolor{background-color}{white}

\setbeamercolor{progress bar}{fg=accent-color}

%
%! Declare pgf layers for z-level in tikz pictures
%!ref: http://tex.stackexchange.com/a/20426
%
\pgfdeclarelayer{back}
\pgfdeclarelayer{front}
\pgfsetlayers{back,main,front}

%! Define tikz keys for layering.
%!ref: http://tex.stackexchange.com/a/20426
%\makeatletter
\pgfkeys{%
  /tikz/on layer/.code={
    \pgfonlayer{#1}\begingroup
    \aftergroup\endpgfonlayer
    \aftergroup\endgroup
  },
  /tikz/node on layer/.code={
    \gdef\node@@on@layer{%
      \setbox\tikz@tempbox=\hbox\bgroup\pgfonlayer{#1}\unhbox\tikz@tempbox\endpgfonlayer\egroup}
    \aftergroup\node@on@layer
  },
  /tikz/end node on layer/.code={
    \endpgfonlayer\endgroup\endgroup}%
}
\def\node@on@layer{\aftergroup\node@@on@layer}

\defbeamertemplate{headline}{my headline}[1][]{%
    \bgroup%
    %! Calculate progress bar width
    \setcounter{@@frames}{\insertframenumber}%
    \setcounter{@@total}{\inserttotalframenumber}%
    \addtocounter{@@frames}{-1}%
    \addtocounter{@@total}{-1}%
    \ifnum\the@@total=0%
        \dimen0=\paperwidth%
    \else%
        \dimen0=\paperwidth%
        \divide\dimen0 by 100%
        \multiply\dimen0 by \the@@frames%
        \divide\dimen0 by \the@@total%
        %! This equals `<paperwidth>/100 * (<frames> - 1) / (<total> - 1) * 100`
        \multiply\dimen 0 by 100%
    \fi%
    \edef\progressbarwidth{\the\dimen0}%
    \begin{beamercolorbox}[wd=\paperwidth, ht=0.5cm]{}%
        % Don't draw the progress bar on the first page
        \ifnum\thepage=1\relax%
        \else%
            \usebeamercolor{progress bar}%
            \begin{tikzpicture}%
                \draw[draw=none, use as bounding box] (0, 0) rectangle (\paperwidth, 0.5cm);%
                % %! Draw the progress bar.
                \draw[on layer=back, draw=none, fill=fg!15] (0, 0) rectangle (\paperwidth, 0.5cm);%
                \draw[on layer=main, draw=none, fill=fg] (0, 0) rectangle (\progressbarwidth, 0.5cm);%
                \draw[on layer=main, draw=fg!35, line width=1pt] (0, 0cm) -- (\paperwidth, 0cm);%
            \end{tikzpicture}%
        \fi
    \end{beamercolorbox}
	\egroup%
}
\setbeamertemplate{headline}[my headline]

\defbeamertemplate{title page}{classy title page}[1][0]{%
	\begingroup\noindent%
	\begin{beamercolorbox}{title page}%
        \vskip2em%
        \begin{beamercolorbox}[sep=0.10cm, center]{}%
            \usebeamerfont{title}\inserttitle\par%
        \end{beamercolorbox}\par%
        \vskip0.5cm\par%
        \begin{beamercolorbox}[sep=0.10cm, center]{}%
            \ifx\insertsubtitle\@empty\relax\else{\usebeamerfont{subtitle}\usebeamercolor[fg]{subtitle}\insertsubtitle}\fi%			
        \end{beamercolorbox}\par%
        \vskip0.25cm\relax%
        \begin{beamercolorbox}[sep=0.20cm, center]{}%
            \ifx\insertinstitute\@empty\relax\else{\usebeamerfont{institute}\usebeamercolor{institute}\insertinstitute}\\\fi%
            {\usebeamerfont{author}\usebeamercolor{author}\insertauthor}\\%
            \ifx\insertdate\@empty\relax\else{\usebeamerfont{date}\usebeamercolor{date}\insertdate}\\\fi%
            \ifx\inserttitlegraphic\@empty\relax\else{\usebeamercolor[fg]{titlegraphic}\inserttitlegraphic}\fi%
        \end{beamercolorbox}\par%
	\end{beamercolorbox}
	\endgroup}
\setbeamertemplate{title page}[classy title page]

\defbeamertemplate*{section page}{classy section page}[1][]{%
	\begingroup\noindent%
		%! use a combination of `\makebox` and `\minipage` for centered content
		\makebox[\textwidth][c]{
		\begin{minipage}[c]{0.85\paperwidth}%
			\vskip2em%
			\begin{beamercolorbox}[sep=0.10cm, center]{section in section page}%
				\usebeamerfont{section in section page}\usebeamercolor{section in section page}\insertsectionnumber.~\insertsection\par%
			\end{beamercolorbox}\par%
			%! Optional subtitle
			\ifx\insertsubsection\@empty\relax%
			\else
				\vskip0.25cm\par%
    			\begin{beamercolorbox}[sep=0.20cm, center]{subsection in section page}%
					\usebeamerfont{subsection in section page}\usebeamercolor{subsection in section page}\insertsectionnumber.\insertsubsectionnumber~~\insertsubsection\par%
				\end{beamercolorbox}\par%
			\fi
		\end{minipage}}%
	\endgroup}
\setbeamertemplate{classy section page}[my section page]


\makeatother
